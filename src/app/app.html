<main class="app">
  <header class="panel topbar">
    <div class="topbar-left">
      <div class="brand-wrap">
        <span class="brand-logo" aria-hidden="true">
          <svg viewBox="0 0 48 48" role="img">
            <circle cx="24" cy="24" r="24"></circle>
            <path d="M10.5 23.9L24 13l13.5 10.9v10.8c0 1.3-1.1 2.4-2.4 2.4h-7.8V28h-6.6v9.1h-7.8c-1.3 0-2.4-1.1-2.4-2.4V23.9z"></path>
          </svg>
        </span>
        <div class="brand">
          <h1>{{ t('app.title') }}</h1>
          <p>{{ t('app.subtitle') }}</p>
        </div>
      </div>
    </div>

    <div class="top-controls">
      <label class="lang-switch nav-select">
        <span>{{ t('lang.label') }}</span>
        <div class="select-wrap">
          <select [(ngModel)]="language" (ngModelChange)="onLanguageChange()">
            @for (lang of languageOptions; track lang) {
              <option [ngValue]="lang">{{ languageLabel(lang) }}</option>
            }
          </select>
          <i class="chevron" aria-hidden="true"></i>
        </div>
      </label>
    </div>
  </header>

  <section class="dashboard">
    <section class="center-column">
      <section class="panel" id="inputs">
        <div class="panel-head">
          <h2>{{ t('panel.inputs.title') }}</h2>
          <p>{{ t('panel.inputs.subtitle') }}</p>
        </div>

        <div class="form-grid">
          <label>
            <span>{{ t('input.loanAmount') }} ({{ currency }})</span>
            <input type="number" min="1" step="100" [(ngModel)]="loanAmount" (ngModelChange)="recalculate()" />
          </label>
          <label>
            <span>{{ t('input.annualInterest') }}</span>
            <input
              type="number"
              min="0"
              step="0.01"
              [(ngModel)]="annualInterestRate"
              (ngModelChange)="recalculate()"
            />
          </label>
          <label>
            <span>{{ t('input.termMonths') }}</span>
            <input type="number" min="1" step="1" [(ngModel)]="loanTermMonths" (ngModelChange)="recalculate()" />
          </label>
          <label>
            <span>{{ t('input.firstPaymentDate') }}</span>
            <input type="date" [(ngModel)]="firstPaymentDate" (ngModelChange)="recalculate()" />
          </label>
          <label>
            <span>{{ t('input.commissionType') }}</span>
            <select [(ngModel)]="commissionMode" (ngModelChange)="recalculate()">
              @for (mode of commissionModeOptions; track mode) {
                <option [ngValue]="mode">{{ commissionModeLabel(mode) }}</option>
              }
            </select>
          </label>
          @if (commissionMode === 'interestRate' || commissionMode === 'balanceRate') {
            <label>
              <span>{{ t('input.commissionRate') }}</span>
              <input
                type="number"
                min="0"
                step="0.01"
                [(ngModel)]="commissionRate"
                (ngModelChange)="recalculate()"
              />
            </label>
          }

          @if (commissionMode === 'fixed') {
            <label>
              <span>{{ t('input.fixedCommission') }} ({{ currency }})</span>
              <input
                type="number"
                min="0"
                step="0.01"
                [(ngModel)]="fixedCommission"
                (ngModelChange)="recalculate()"
              />
            </label>
          }
        </div>

        <div class="subcard prepay">
          <div class="prepay-head">
            <h3>{{ t('prepay.title') }}</h3>
            <button type="button" class="prepay-add" (click)="addExtraPayment()">{{ t('common.add') }}</button>
          </div>
          @if (isCompactLayout) {
            <div class="prepay-cards">
              @for (item of extraPayments; track item.id) {
                <article class="prepay-card">
                  <div class="prepay-card-grid">
                    <label>
                      <span>{{ t('prepay.month') }}</span>
                      <input
                        type="number"
                        min="1"
                        step="1"
                        [(ngModel)]="item.month"
                        (ngModelChange)="recalculate()"
                      />
                    </label>
                    <label>
                      <span>{{ t('prepay.amount') }}</span>
                      <input
                        type="number"
                        min="0"
                        step="0.01"
                        [(ngModel)]="item.amount"
                        (ngModelChange)="recalculate()"
                      />
                    </label>
                    <label class="prepay-card-strategy">
                      <span>{{ t('prepay.effect') }}</span>
                      <select [(ngModel)]="item.strategy" (ngModelChange)="recalculate()">
                        @for (strategy of prepaymentStrategyOptions; track strategy) {
                          <option [ngValue]="strategy">{{ prepaymentStrategyLabel(strategy) }}</option>
                        }
                      </select>
                    </label>
                  </div>
                  <button type="button" class="remove prepay-remove" (click)="removeExtraPayment(item.id)">
                    {{ t('common.remove') }}
                  </button>
                </article>
              }
            </div>
          } @else {
            <div class="table-shell short prepay-table">
              <table>
                <thead>
                  <tr>
                    <th>{{ t('prepay.month') }}</th>
                    <th>{{ t('prepay.amount') }}</th>
                    <th>{{ t('prepay.effect') }}</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of extraPayments; track item.id) {
                    <tr>
                      <td>
                        <input
                          type="number"
                          min="1"
                          step="1"
                          [(ngModel)]="item.month"
                          (ngModelChange)="recalculate()"
                        />
                      </td>
                      <td>
                        <input
                          type="number"
                          min="0"
                          step="0.01"
                          [(ngModel)]="item.amount"
                          (ngModelChange)="recalculate()"
                        />
                      </td>
                      <td>
                        <select [(ngModel)]="item.strategy" (ngModelChange)="recalculate()">
                          @for (strategy of prepaymentStrategyOptions; track strategy) {
                            <option [ngValue]="strategy">{{ prepaymentStrategyLabel(strategy) }}</option>
                          }
                        </select>
                      </td>
                      <td>
                        <button type="button" class="remove" (click)="removeExtraPayment(item.id)">
                          {{ t('common.remove') }}
                        </button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </section>

      <section class="panel" id="charts">
        <div class="panel-head">
          <h2>{{ t('panel.results.title') }}</h2>
          <p>{{ t('panel.results.subtitle') }}</p>
        </div>

        @if (errorMessage) {
          <div class="error-box">
            <h2>{{ t('error.title') }}</h2>
            <p>{{ errorMessage }}</p>
          </div>
        } @else {
          <div class="metrics">
            <article>
              <p>{{ t('metric.basePayment') }}</p>
              <strong>{{ paymentUsed | number: '1.2-2' }} {{ currency }}</strong>
            </article>
            <article>
              <p>{{ t('metric.interestSaved') }}</p>
              <strong>{{ interestSaved | number: '1.2-2' }} {{ currency }}</strong>
            </article>
            <article>
              <p>{{ t('metric.commissionSaved') }}</p>
              <strong>{{ commissionSaved | number: '1.2-2' }} {{ currency }}</strong>
            </article>
            <article>
              <p>{{ t('metric.totalSaved') }}</p>
              <strong>{{ totalCostSaved | number: '1.2-2' }} {{ currency }}</strong>
            </article>
          </div>
          <p class="result-note">
            {{ t('metric.totalInterestToPay') }}:
            <strong>{{ totalInterestToPay | number: '1.2-2' }} {{ currency }}</strong>
          </p>

          @if (hasChartData) {
            <article class="chart-single">
              <h3>{{ t('chart.title') }}</h3>
              <div class="mix-chart">
                <div class="mix-bars">
                  @for (bar of paymentMixBars; track bar.year) {
                    <div
                      class="mix-col"
                      [attr.title]="barTitle(bar)"
                      tabindex="0"
                      (mouseenter)="hoveredBarYear = bar.year"
                      (mouseleave)="hoveredBarYear = null"
                      (focusin)="hoveredBarYear = bar.year"
                      (focusout)="hoveredBarYear = null"
                    >
                      @if (hoveredBarYear === bar.year) {
                        <div class="bar-card">
                          <strong>{{ bar.year }}</strong>
                          <div class="bar-card-row">
                            <span>{{ t('chart.principalInclExtra') }}</span>
                            <b>{{ bar.principalPaid | number: '1.2-2' }} {{ currency }}</b>
                          </div>
                          <div class="bar-card-row">
                            <span>{{ t('chart.extraPrepayment') }}</span>
                            <b>{{ bar.extraPaid | number: '1.2-2' }} {{ currency }}</b>
                          </div>
                          <div class="bar-card-row">
                            <span>{{ t('chart.paidVsLoanYear') }}</span>
                            <b>{{ bar.principalLoanPct | number: '1.2-2' }}%</b>
                          </div>
                          <div class="bar-card-row">
                            <span>{{ t('chart.cumulativePaidVsLoan') }}</span>
                            <b>{{ bar.cumulativePrincipalLoanPct | number: '1.2-2' }}%</b>
                          </div>
                          <div class="bar-card-row">
                            <span>{{ t('chart.principalPct') }}</span>
                            <b>{{ bar.principalPct | number: '1.2-2' }}%</b>
                          </div>
                          <div class="bar-card-row">
                            <span>{{ t('chart.interest') }}</span>
                            <b>{{ bar.interestPaid | number: '1.2-2' }} {{ currency }}</b>
                          </div>
                          <div class="bar-card-row">
                            <span>{{ t('chart.interestPct') }}</span>
                            <b>{{ bar.interestPct | number: '1.2-2' }}%</b>
                          </div>
                          <div class="bar-card-row total">
                            <span>{{ t('chart.total') }}</span>
                            <b>{{ bar.totalPaid | number: '1.2-2' }} {{ currency }}</b>
                          </div>
                        </div>
                      }
                      <div class="mix-stack" [style.height.px]="bar.columnHeightPx">
                        <span class="seg principal" [style.flex-grow]="bar.principalPaid"></span>
                        <span class="seg interest" [style.flex-grow]="bar.interestPaid"></span>
                      </div>
                      <em>{{ bar.totalPaid | number: '1.0-0' }}</em>
                      <small>{{ bar.year }}</small>
                    </div>
                  }
                </div>
              </div>
              <div class="legend">
                <span><i class="dot principal"></i> {{ t('chart.principal') }}</span>
                <span><i class="dot interest"></i> {{ t('chart.interest') }}</span>
              </div>
              <p class="chart-hint">{{ t('chart.hint') }}</p>
            </article>
          }
        }
      </section>

      @if (!errorMessage) {
        <section class="panel" id="schedule">
          <div class="panel-head">
            <h2>{{ t('panel.schedule.title') }}</h2>
            <p>{{ t('panel.schedule.subtitle') }}</p>
          </div>

          <div class="schedule-meta">
            <article>
              <span>{{ t('schedule.payoffDate') }}</span>
              <strong>{{ completionDate | date: 'dd MMM yyyy' }}</strong>
            </article>
            <article>
              <span>{{ t('schedule.monthsReduced') }}</span>
              <strong>{{ monthsReduced }}</strong>
            </article>
            <article>
              <span>{{ t('schedule.totalSaved') }}</span>
              <strong>{{ totalCostSaved | number: '1.2-2' }} {{ currency }}</strong>
            </article>
          </div>

          @if (isCompactLayout) {
            <div class="schedule-cards">
              @for (row of visibleScheduleRows; track row.month) {
                <article class="schedule-card">
                  <header class="schedule-card-head">
                    <strong>{{ t('prepay.month') }} {{ row.month }}</strong>
                    <small>{{ row.dueDate | date: 'dd MMM yyyy' }}</small>
                  </header>
                  <div class="schedule-kv payment">
                    <span>{{ t('schedule.payment') }}</span>
                    <b>{{ row.totalPaymentDue | number: '1.2-2' }}</b>
                  </div>
                  <div class="schedule-kv">
                    <span>{{ t('schedule.principal') }}</span>
                    <b>{{ row.principalPaid | number: '1.2-2' }}</b>
                  </div>
                  <div class="schedule-kv">
                    <span>{{ t('schedule.interest') }}</span>
                    <b>{{ row.interestPaid | number: '1.2-2' }}</b>
                  </div>
                  <div class="schedule-kv">
                    <span>{{ t('schedule.commission') }}</span>
                    <b>{{ row.commissionPaid | number: '1.2-2' }}</b>
                  </div>
                  <div class="schedule-kv">
                    <span>{{ t('schedule.extra') }}</span>
                    <b>{{ row.extraPayment | number: '1.2-2' }}</b>
                  </div>
                  <div class="schedule-kv">
                    <span>{{ t('schedule.endingBalance') }}</span>
                    <b>{{ row.endingBalance | number: '1.2-2' }}</b>
                  </div>
                  <div class="schedule-kv emphasis">
                    <span>{{ t('schedule.savedInterest') }}</span>
                    <b>{{ row.cumulativeInterestSaved | number: '1.2-2' }}</b>
                  </div>
                </article>
              }
            </div>
            @if (hasMoreScheduleRows) {
              <button type="button" class="schedule-more" (click)="showMoreScheduleRows()">
                {{ t('common.showMoreRows', { count: mobileScheduleStep }) }}
              </button>
            }
          } @else {
            <div class="table-shell">
              <table>
                <thead>
                  <tr>
                    <th>{{ t('schedule.date') }}</th>
                    <th>{{ t('schedule.payment') }}</th>
                    <th>{{ t('schedule.principal') }}</th>
                    <th>{{ t('schedule.interest') }}</th>
                    <th>{{ t('schedule.commission') }}</th>
                    <th>{{ t('schedule.extra') }}</th>
                    <th>{{ t('schedule.startingBalance') }}</th>
                    <th>{{ t('schedule.endingBalance') }}</th>
                    <th>{{ t('schedule.savedInterest') }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (row of planRows; track row.month) {
                    <tr>
                      <td>{{ row.dueDate | date: 'dd/MM/yyyy' }}</td>
                      <td>{{ row.totalPaymentDue | number: '1.2-2' }}</td>
                      <td>{{ row.principalPaid | number: '1.2-2' }}</td>
                      <td>{{ row.interestPaid | number: '1.2-2' }}</td>
                      <td>{{ row.commissionPaid | number: '1.2-2' }}</td>
                      <td>{{ row.extraPayment | number: '1.2-2' }}</td>
                      <td>{{ row.startingBalance | number: '1.2-2' }}</td>
                      <td>{{ row.endingBalance | number: '1.2-2' }}</td>
                      <td>{{ row.cumulativeInterestSaved | number: '1.2-2' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </section>
      }
    </section>

    <aside class="right-rail">
      @if (!errorMessage) {
        <article class="panel rail-card">
          <div class="ai-head">
            <span class="ai-badge">{{ t('ai.badge') }}</span>
            <h3>{{ t('ai.title') }}</h3>
          </div>
          <p class="ai-subtitle">{{ t('ai.subtitle') }}</p>
          <div class="ai-connect">
            <button type="button" [disabled]="aiStatus === 'loading'" (click)="requestAiSuggestions()">
              {{ aiActionLabel }}
            </button>
            <p class="ai-status" [class.ok]="aiStatus === 'connected'" [class.error]="aiStatus === 'error'">
              {{ aiStatusText }}
            </p>
          </div>

          @if (aiCoachSummary; as coach) {
            <article class="ai-summary">
              <h4>{{ t('ai.summary.title') }}</h4>
              <div class="ai-summary-row">
                <span>{{ t('ai.summary.bestMonths') }}</span>
                <b>{{ coachBestMonthsText(coach) }}</b>
              </div>
              <p class="ai-summary-line">{{ t('ai.summary.bestMonthsNote') }}</p>
              <div class="ai-summary-row">
                <span>{{ t('ai.summary.strategy') }}</span>
                <b>{{ prepaymentStrategyLabel(coach.recommendedStrategy) }}</b>
              </div>
              <div class="ai-summary-row">
                <span>{{ t('ai.summary.phase') }}</span>
                <b>{{ phaseLabel(coach.currentPhase) }}</b>
              </div>
              <div class="ai-summary-row">
                <span>{{ t('ai.summary.extraTier') }}</span>
                <b>{{ extraTierLabel(coach.recommendedTier) }}</b>
              </div>
              <p class="ai-summary-line">{{ coachImpactText(coach) }}</p>
              <p class="ai-summary-line">{{ t('ai.summary.tip') }}</p>
              <p class="ai-summary-line">{{ t('ai.summary.timing.' + coach.timingAdvice) }}</p>
              <p class="ai-summary-line">{{ t('ai.summary.pattern.' + coach.paymentPattern) }}</p>
              @if (coach.budgetRisk) {
                <p class="ai-summary-line warning">{{ t('ai.summary.risk') }}</p>
              }
            </article>
          }

          <div class="ai-list">
            @for (tip of aiPrepaymentTips; track tip.month) {
              <article class="ai-tip">
                <header>
                  <strong>{{ t('prepay.month') }} {{ tip.month }}</strong>
                  <small>{{ tip.dueDate | date: 'dd MMM yyyy' }}</small>
                </header>

                <div class="ai-kv">
                  <span>{{ t('ai.interestMonth') }}</span>
                  <b>{{ tip.interestPaid | number: '1.2-2' }} {{ currency }}</b>
                </div>
                <div class="ai-kv">
                  <span>{{ t('ai.shareMonth') }}</span>
                  <b>{{ tip.interestSharePct | number: '1.2-2' }}%</b>
                </div>
                <div class="ai-kv">
                  <span>{{ t('ai.suggestedExtra') }}</span>
                  <b>{{ tip.suggestedExtra | number: '1.2-2' }} {{ currency }}</b>
                </div>
                <div class="ai-kv">
                  <span>{{ t('ai.estimatedSaved') }}</span>
                  <b>{{ tip.estimatedInterestSaved | number: '1.2-2' }} {{ currency }}</b>
                </div>
                @if (tip.reason) {
                  <div class="ai-kv stacked">
                    <span>{{ t('ai.reason') }}</span>
                    <b>{{ tip.reason }}</b>
                  </div>
                }

                <button type="button" (click)="applyAiTip(tip)">
                  {{ t('ai.action') }}
                </button>
              </article>
            } @empty {
              <p class="ai-empty">{{ t('ai.empty') }}</p>
            }
          </div>
          <p class="ai-note">{{ t('ai.note') }}</p>
        </article>
      }

      <article class="panel rail-card tips-card">
        <h3>{{ t('tips.title') }}</h3>
        <ul>
          <li>{{ t('tips.one') }}</li>
          <li>{{ t('tips.two') }}</li>
          <li>{{ t('tips.three') }}</li>
        </ul>
      </article>

      <article class="panel rail-card ad-slot">
        <p class="ad-label">{{ t('ads.label') }}</p>
        <h3>{{ t('ads.title') }}</h3>
        <p>{{ t('ads.body') }}</p>
        <button type="button">{{ t('ads.cta') }}</button>
      </article>
    </aside>
  </section>
</main>
